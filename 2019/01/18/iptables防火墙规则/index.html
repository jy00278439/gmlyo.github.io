<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iptables防火墙数据包过滤软件," />





  <link rel="alternate" href="/atom.xml" title="G加菲" type="application/atom+xml" />






<meta name="description" content="iptables防火墙数据包过滤软件iptables 的表 (table) 与链 (chain)">
<meta name="keywords" content="iptables防火墙数据包过滤软件">
<meta property="og:type" content="article">
<meta property="og:title" content="iptables防火墙数据包过滤软件">
<meta property="og:url" content="http://www.gmlyo.com/2019/01/18/iptables防火墙规则/index.html">
<meta property="og:site_name" content="G加菲">
<meta property="og:description" content="iptables防火墙数据包过滤软件iptables 的表 (table) 与链 (chain)">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-01-17T18:00:16.576Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iptables防火墙数据包过滤软件">
<meta name="twitter:description" content="iptables防火墙数据包过滤软件iptables 的表 (table) 与链 (chain)">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.gmlyo.com/2019/01/18/iptables防火墙规则/"/>






  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "2d322328"
    });
  daovoice('update');
  </script>


  <title>iptables防火墙数据包过滤软件 | G加菲</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">G加菲</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.gmlyo.com/2019/01/18/iptables防火墙规则/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="G加菲">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/20180226143321.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="G加菲">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iptables防火墙数据包过滤软件</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-18T01:49:41+08:00">
                2019-01-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iptables笔记/" itemprop="url" rel="index">
                    <span itemprop="name">iptables笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="iptables防火墙数据包过滤软件"><a href="#iptables防火墙数据包过滤软件" class="headerlink" title="iptables防火墙数据包过滤软件"></a>iptables防火墙数据包过滤软件</h1><h2 id="iptables-的表-table-与链-chain"><a href="#iptables-的表-table-与链-chain" class="headerlink" title="iptables 的表 (table) 与链 (chain)"></a>iptables 的表 (table) 与链 (chain)</h2><a id="more"></a>
<h3 id="Filter（过滤器）"><a href="#Filter（过滤器）" class="headerlink" title="Filter（过滤器）"></a>Filter（过滤器）</h3><p>主要跟进入 Linux 本机的数据包有关，是默认的 table。</p>
<ul>
<li>INPUT：主要与想要进入我们 Linux 本机的数据包有关。</li>
<li>OUTPUT：主要与我们 Linux 本机所要送出的数据包有关。</li>
<li>FORWARD：这个与 Linux 本机比较没有关系，他可以转递数据包到后端的计算机中，与下列 NAT 的 table 相关性较高。</li>
</ul>
<h3 id="NAT（地址转换）"><a href="#NAT（地址转换）" class="headerlink" title="NAT（地址转换）"></a>NAT（地址转换）</h3><p>是 Network Address Translation 的缩写， 这个表格主要在进行来源与目的之 IP 或 port 的转换，与 Linux 本机较无关，主要与 Linux 主机后的局域网络内计算机较有相关。</p>
<ul>
<li>PREROUTING：在进行路由判断之前所要进行的规则 (DNAT/REDIRECT)</li>
<li>POSTROUTING：在进行路由判断之后所要进行的规则 (SNAT/MASQUERADE)</li>
<li>OUTPUT：与发送出去的数据包有关</li>
</ul>
<h3 id="Mangle（破坏者）"><a href="#Mangle（破坏者）" class="headerlink" title="Mangle（破坏者）"></a>Mangle（破坏者）</h3><p>这个表格主要是与特殊的数据包的路由标志有关，早期仅有 PREROUTING 及 OUTPUT 链，不过从 kernel 2.4.18 之后加入了 INPUT 及 FORWARD 链。由于这个表格与特殊标志相关性较高，所以在我们讨论的这种单纯的环境当中，较少使用 Mangle 这个表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t tables] [-L] [-nv]</span><br><span class="line">选项与参数：</span><br><span class="line">-t  <span class="comment"># 后面接 table ，例如 nat 或 filter ，若省略此项目，则使用默认的 filter</span></span><br><span class="line">-L  <span class="comment"># 列出目前的 table 的规则</span></span><br><span class="line">-n  <span class="comment"># 不进行 IP 与 HOSTNAME 的反查，显示信息的速度会快很多</span></span><br><span class="line">-v  <span class="comment"># 列出更多的信息，包括通过该规则的数据包总位数、相关的网络接口等</span></span><br></pre></td></tr></table></figure>
<h2 id="列出-filter-table-三条链的规则"><a href="#列出-filter-table-三条链的规则" class="headerlink" title="列出 filter table 三条链的规则"></a>列出 filter table 三条链的规则</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n</span><br><span class="line">Chain INPUT (policy ACCEPT)    <span class="comment"># 针对 INPUT 链，且默认政策为可接受</span></span><br><span class="line">target  prot opt <span class="built_in">source</span>     destination    <span class="comment"># 说明栏</span></span><br><span class="line">ACCEPT  all  --  0.0.0.0/0  0.0.0.0/0   state RELATED,ESTABLISHED  <span class="comment"># 第 1 条规则</span></span><br><span class="line">ACCEPT  icmp --  0.0.0.0/0  0.0.0.0/0                              <span class="comment"># 第 2 条规则</span></span><br><span class="line">ACCEPT  all  --  0.0.0.0/0  0.0.0.0/0                              <span class="comment"># 第 3 条规则</span></span><br><span class="line">ACCEPT  tcp  --  0.0.0.0/0  0.0.0.0/0   state NEW tcp dpt:22       <span class="comment"># 以下类推</span></span><br><span class="line">REJECT  all  --  0.0.0.0/0  0.0.0.0/0   reject-with icmp-host-prohibited</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)    <span class="comment"># 针对 FORWARD 链，且默认政策为可接受</span></span><br><span class="line">target  prot opt <span class="built_in">source</span>     destination</span><br><span class="line">REJECT  all  --  0.0.0.0/0  0.0.0.0/0   reject-with icmp-host-prohibited</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)    <span class="comment"># 针对 OUTPUT 链，且默认政策为可接受</span></span><br><span class="line">target  prot opt <span class="built_in">source</span>     destination</span><br></pre></td></tr></table></figure>
<h2 id="列出-nat-table-三条链的规则"><a href="#列出-nat-table-三条链的规则" class="headerlink" title="列出 nat table 三条链的规则"></a>列出 nat table 三条链的规则</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -L -n</span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure>
<p>上面的输出结果中，每一个 Chain 就是前面提到的每个链。Chain 那一行括号里面的 policy 就是默认的策略。</p>
<ul>
<li>target：代表进行的操作，ACCEPT 是放行，而 REJECT 则是拒绝，此外，尚有 DROP (丢弃) 的项目。</li>
<li>prot：代表使用的数据包协议，主要有 TCP、UDP 及 ICMP 3 种数据包格式。</li>
<li>opt：额外的选项说明。</li>
<li>source：代表此规则是针对哪个 <code>来源IP</code> 进行限制。</li>
<li>destination：代表此规则是针对哪个 <code>目标IP</code> 进行限制。</li>
</ul>
<p>第一个范例因为没有加上 <code>-t</code> 的选项，所以默认就是 filter 这个表格内的 INPUT、OUTPUT、FORWARD 三条链的规则。<br>若针对单机来说，INPUT 与 FORWARD 算是比较重要的管制防火墙链， 所以可以发现最后一条规则的政策是 REJECT（拒绝）！虽然 INPUT 与 FORWARD 的政策是放行 (ACCEPT)， 不过最后一条规则就已经将全部的数据包都拒绝了！</p>
<p>这个命令的查看只是做格式化的查看，要详细解释每个规则会比较不容易。举例来说， 我们将 INPUT 的 5 条规则依据输出结果来说明一下，结果会变成：</p>
<ol>
<li>只要是数据包状态为 RELATED、ESTABLISHED 就予以接受</li>
<li>只要数据包协议是 icmp 类型的，就予以放行</li>
<li>无论任何来源 (0.0.0.0/0) 且要去任何目标的数据包，不论任何数据包格式 (prot 为 all)，一律都接受</li>
<li>只要是传给 port 22 的主动式连接 TCP 数据包就接受</li>
<li>全部的数据包信息一律拒绝</li>
</ol>
<p>还有第 3 条规则怎么会所有的数据包信息都予以接受呢？如果都接受的话，那么后续的规则根本就没有用了！ 其实那条规则只是针对每台主机都有的内部循环测试网络 (lo) 接口，如果没有列出接口，那么我们就很容易搞错。所以，建议使用 <code>iptables-save</code> 这个指令来查看防火墙规则。因为 <code>iptables-save</code> 会列出完整的防火墙规则，只是没有格式化输出而已。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">iptables-save [-t table]</span><br><span class="line">选项与参数：</span><br><span class="line">-t  <span class="comment"># 可以仅针对某些表来输出，例如仅针对 NAT 或 Filter 等</span></span><br><span class="line"></span><br><span class="line">iptables-save</span><br><span class="line"><span class="comment"># Generated by iptables-save v1.4.7 on Fri Jul 22 15:51:52 2011</span></span><br><span class="line">*filter                       <span class="comment"># 星号开头的指的是表，这里为 Filter</span></span><br><span class="line">:INPUT ACCEPT [0:0]           <span class="comment"># 冒号开头的指的是链，3条内建的链</span></span><br><span class="line">:FORWARD ACCEPT [0:0]         <span class="comment"># 3条内建链的策略都是 ACCEPT</span></span><br><span class="line">:OUTPUT ACCEPT [680:100461]</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT    <span class="comment"># 针对 INPUT 的规则</span></span><br><span class="line">-A INPUT -p icmp -j ACCEPT</span><br><span class="line">-A INPUT -i lo -j ACCEPT      <span class="comment"># 这条很重要，针对本机内部接口开放</span></span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">-A FORWARD -j REJECT --reject-with icmp-host-prohibited    <span class="comment"># 针对 FORWARD 的规则</span></span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment"># Completed on Fri Jul 22 15:51:52 2011</span></span><br></pre></td></tr></table></figure>
<p>上面输出结果来看，内容含有 <code>lo</code> 的那条规则当中，<code>-i lo</code> 指的就是由 <code>lo</code> 网卡进来的数据包。这样就清楚多了！因为有写到接口的关系，不像之前的 <code>iptables -L -n</code>。不过，既然这个规则不是我们想要的，那该如何修改呢？建议先删除规则再慢慢建立各个需要的规则。那如何清除规则？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t tables] [-FXZ]</span><br><span class="line">选项与参数：</span><br><span class="line">-F  <span class="comment"># 清除所有的已制订的规则</span></span><br><span class="line">-X  <span class="comment"># 除掉所有用户 "自定义" 的 chain (应该说的是 tables ）</span></span><br><span class="line">-Z  <span class="comment"># 将所有的 chain 的计数与流量统计都归零</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除本机防火墙 (filter) 的所有规则</span></span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br></pre></td></tr></table></figure>
<p>由于这三条命令会将本机防火墙的所有规则都清除，但不会改变默认策略 (policy) ， 所以如果你不是在本机使用这三行命令时，很可能会将自己挡在门外（若 INPUT 设置为 DROP 时）要注意！</p>
<p>一般来说，我们在重新定义防火墙的时候，都会先将规则给清除掉。我们前面说到的 <strong>防火墙的规则顺序是有特殊意义的</strong>，所以，应当先清除掉规则，然后再一条一条来设置会比较容易一些。接下来就谈谈如何定义默认策略。</p>
<h2 id="定义默认策略-policy"><a href="#定义默认策略-policy" class="headerlink" title="定义默认策略 (policy)"></a>定义默认策略 (policy)</h2><p>清除规则之后，接下来就是要设置规则的策略。还记得策略指的是什么吗？<strong>当数据包不在我们设置的规则之内时，则该数据包的通过与否，是以 Policy 的设置为准</strong>，在本机的默认策略中，假设对于内部的用户有信心的话， 那么 Filter 内的 INPUT 链方面可以定义的比较严格一点，而 FORWARD 与 OUTPUT 则可以制订得松一些。通常都是将 INPUT 的 policy 定义为 DROP ，其他两个则定义为 ACCEPT。 至于 NAT table 则暂时先不理会。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t nat] -P [INPUT,OUTPUT,FORWARD] [ACCEPT,DROP]</span><br><span class="line">选项与参数：</span><br><span class="line">-P      <span class="comment"># 定义策略 (Policy)。注意，这个 P 为大写</span></span><br><span class="line">ACCEPT  <span class="comment"># 该数据包可接受</span></span><br><span class="line">DROP    <span class="comment"># 该数据包直接丢弃，不会让 Client 端知道为何被丢弃</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>将本机的 INPUT 设置为 DROP ，其他设置为 ACCEPT</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line">iptables-save</span><br><span class="line"><span class="comment"># Generated by iptables-save v1.4.7 on Fri Jul 22 15:56:34 2011</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT DROP [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment"># Completed on Fri Jul 22 15:56:34 2011</span></span><br><span class="line"><span class="comment"># 由于 INPUT 设置为 DROP 而又尚未有任何规则，所以上面的输出结果显示</span></span><br><span class="line"><span class="comment"># 所有的数据包都无法进入的主机，是不通的防火墙设置！(网络连接是双向的)</span></span><br></pre></td></tr></table></figure>
<p>看到输出的结果，INPUT 的设置被修改了，其他的 NAT table 3 条链的默认策略设置也是一样的方式。<br>例如：<br><code>iptables -t nat -P PREROUTING ACCEPT</code> 就设置了 NAT table 的 PREROUTING 链为可接受。默认策略设置完毕后，来聊一聊关于各规则的数据包基础比对设置。</p>
<h2 id="数据包的基础比对：IP，网络及接口设备"><a href="#数据包的基础比对：IP，网络及接口设备" class="headerlink" title="数据包的基础比对：IP，网络及接口设备"></a>数据包的基础比对：IP，网络及接口设备</h2><p>开始来进行防火墙规则的数据包比对设置。既然是因特网，那么我们就由最基础的 IP，网络及端口，亦即是 OSI 的第三层谈起，再来谈谈设备网卡的限制等等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">iptables [-AI 链名] [-io 网络接口] [-p 协议] [-s 来源IP/网域] [-d 目标IP/网域] -j [ACCEPT|DROP|REJECT|LOG]</span><br><span class="line">选项与参数：</span><br><span class="line">-AI 链名  <span class="comment"># 针对某的链进行规则的 "插入" 或 "累加"</span></span><br><span class="line">    -A   <span class="comment"># 新增加一条规则，该规则增加在原本规则的最后面。</span></span><br><span class="line">         <span class="comment"># 例如原本已经有四条规则，使用 -A 就可以加上第五条规则</span></span><br><span class="line">    -I   <span class="comment"># 插入一条规则。如果没有指定此规则的顺序，默认是插入变成第一条规则。</span></span><br><span class="line">         <span class="comment"># 例如原本有四条规则，使用 -I 则该规则变成第一条，而原本 4 条变成 2~5 条</span></span><br><span class="line">    链   <span class="comment"># 有 INPUT、OUTPUT、FORWARD 等，此链名称又与 -io 有关，请看下面</span></span><br><span class="line"></span><br><span class="line">-io 网络接口  <span class="comment"># 设置数据包进出的接口规范</span></span><br><span class="line">    -i  <span class="comment"># 数据包所进入的那个网络接口，例如 eth0、lo 等接口。需与 INPUT 链配合</span></span><br><span class="line">    -o  <span class="comment"># 数据包所传出的那个网络接口，需与 OUTPUT 链配合</span></span><br><span class="line"></span><br><span class="line">-p 协定  <span class="comment"># 设置此规则适用于哪种数据包格式</span></span><br><span class="line">        <span class="comment"># 主要的数据包格式有：tcp、udp、icmp 及 all</span></span><br><span class="line"></span><br><span class="line">-s 来源 IP/网域  <span class="comment"># 设置此规则之数据包的来源项目，可指定单纯的 IP 或包括网域，例如：</span></span><br><span class="line">   IP    <span class="comment"># 192.168.0.100</span></span><br><span class="line">   网络  <span class="comment"># 192.168.0.0/24, 192.168.0.0/255.255.255.0 均可</span></span><br><span class="line">   <span class="comment"># 若规范为 “不许” 时，则加上 “!” 即可，例如：</span></span><br><span class="line">   -s ! 192.168.100.0/24  <span class="comment"># 表示不接受 192.168.100.0/24 发来的数据包</span></span><br><span class="line"></span><br><span class="line">-d 目标 IP/网络  <span class="comment"># 同 -s ，只不过这里指的是目标的 IP 或网络</span></span><br><span class="line"></span><br><span class="line">-j  <span class="comment"># 后面接操作，主要的操作有接受(ACCEPT)、丢弃(DROP)、拒绝(REJECT)及记录(LOG)</span></span><br></pre></td></tr></table></figure>
<p>iptables 的基本参数就如同上面所示，仅谈到 IP 、网络与设备等的信息， 至于 TCP、UDP 数据包特有的端口 (port number) 与状态（如 SYN 标志）则在后面介绍。先让我们来看看最基础的几个规则，例如开放 lo 这个本机的接口以及某个 IP 来源。</p>
<blockquote>
<p>设定 lo 成为受信任的装置，亦即进出 lo 的封包都予以接受</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>仔细看上面并没有列出 -s、-d 等等的规则，这表示：<strong>不论数据包来自何处或去到哪里，只要是来自 lo 这个接口，就予以接受。</strong>这个概念挺重要的，就是“没有指定的项目，则表示该项目完全接受”。例如这个案例当中，关于 -s、-d 等的参数没有规定时，就代表不论什么值都会被接受。</p>
<p>这就是所谓的信任设备。假如主机有两张以太网卡，其中一张是对内部的网络，假设该网卡的代号为 eth1， 如果内部网络是可信任的，那么该网卡的进出数据包就通通会被接受，那就可以用 <code>iptables -A INPUT -i eth1 -j ACCEPT</code> 来将该设备设置为信任设备。不过，使用这个命令前要特别注意，因为这样等于该网卡没有任何防备了。</p>
<blockquote>
<p>只要是来自内网的 (192.168.100.0/24) 的数据包通通接受</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eth1 -s 192.168.100.0/24 -j ACCEPT</span><br><span class="line"><span class="comment"># 由于是内网就接受，因此也可以称之为“信任网络”</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>只要是来自 192.168.100.10 就接受，但 192.168.100.230 这个“恶意”来源就丢弃</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eth1 -s 192.168.100.10 -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth1 -s 192.168.100.230 -j DROP</span><br><span class="line"><span class="comment"># 针对单一 IP 来源，可视为信任主机或者是不信任的恶意来源</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iptables-save</span><br><span class="line"><span class="comment"># Generated by iptables-save v1.4.7 on Fri Jul 22 16:00:43 2011</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT DROP [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [17:1724]</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.100.0/24 -i eth1 -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.100.10/32 -i eth1 -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.100.230/32 -i eth1 -j DROP</span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment"># Completed on Fri Jul 22 16:00:43 2011</span></span><br></pre></td></tr></table></figure>
<p>这就是最简单的防火墙规则的设置与查看方式。不过，在上面的案例中，其实也可以发现到有两条规则可能有问题，那就是上面的特殊字体圈起来的规则顺序。明明已经放行了 192.168.100.0/24，所以 192.168.100.230 的规则就不可能会被用到了！这就是防火墙设置的问题。那该怎么办？重写。那如果想要记录某个规则的记录怎么办？可以这样做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 192.168.2.200 -j LOG</span><br><span class="line">iptables -L -n</span><br><span class="line">target prot opt <span class="built_in">source</span>         destination</span><br><span class="line">LOG    all  --  192.168.2.200  0.0.0.0/0   LOG flags 0 level 4</span><br></pre></td></tr></table></figure>
<p>输出结果的最左边出现 LOG。只要有数据包来自 192.168.2.200 这个 IP 时，那么该数据包的相关信息就会被写入到内核日志文件，即 <code>/var/log/messages</code> 这个文件当中。<strong>然后该数据包会继续进行后续的规则比对。</strong>所以说，LOG 这个动作仅在进行记录而已，并不会影响到这个数据包的其他规则比对。接下来我们分别来看看 TCP、UDP 以及 ICMP 数据包的其他规则比对。</p>
<h2 id="TCP、UDP-的规则比对：针对端口设置"><a href="#TCP、UDP-的规则比对：针对端口设置" class="headerlink" title="TCP、UDP 的规则比对：针对端口设置"></a>TCP、UDP 的规则比对：针对端口设置</h2><p>网络中各种不同的数据包格式，TCP 与 UDP，比较特殊的就是那个端口 (port)，在 TCP 方面则另外有所谓的连接数据包状态，包括最常见的 SYN 主动连接的数据包格式。那么如何针对这两种数据包格式进行防火墙规则的设置呢？可以这样看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables [-AI 链] [-io 网络接口] [-p tcp,udp] \</span><br><span class="line">&gt; [-s 来源IP/网络] [--sport 端口范围] \</span><br><span class="line">&gt; [-d 目标IP/网络] [--dport 端口范围] -j [ACCEPT|DROP|REJECT]</span><br><span class="line">选项与参数：</span><br><span class="line">--sport 端口范围  <span class="comment"># 限制来源的端口号码，端口号码可以是连续的，例如 1024:65535</span></span><br><span class="line">--dport 端口范围  <span class="comment"># 限制目标的端口号码</span></span><br></pre></td></tr></table></figure>
<p>事实上就是多了 <code>--sport</code> 及 <code>--dport</code> 这两个选项，重点在 port 上面。不过需要特别注意，<strong>因为只有 TCP 与 UDP 数据包具有端口，因此要想使用 <code>--dport</code>、<code>--sport</code> 时，得要加上 <code>-p tcp</code> 或 <code>-p udp</code> 的参数才会成功。</strong>下面让我们来进行几个小测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 想要连接进入本机 port 21 的数据包都阻挡掉</span></span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 21 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 想连到本台主机的网上邻居 (upd port 137,138 tcp port 139,445) 就放行</span></span><br><span class="line">iptables -A INPUT -i eth0 -p udp --dport 137:138 -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 139 -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --dport 445 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>我们不但可以利用 UDP 与 TCP 协议所拥有的端口号码来进行某些服务的开放或关闭，还可以综合处理。<br>例如，只要来自 192.168.1.0/24 的 1024:65535 端口的数据包，且想要连接到本机的 ssh port 就予以阻挡，可以这样做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eth0 -p tcp -s 192.168.1.0/24 \</span><br><span class="line">&gt; --sport 1024:65534 --dport ssh -j DROP</span><br></pre></td></tr></table></figure>
<p>如果忘记加上 <code>-p tcp</code> 就使用了 <code>--dport</code> 时，会发生以下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`[root@www ~]<span class="comment"># iptables -A INPUT -i eth0 --dport 21 -j DROP iptables v1.4.7: unknown option `--dport' Try `iptables -h' or 'iptables --help' for more information.`</span></span><br></pre></td></tr></table></figure>
<p>你应该会觉得很奇怪，怎么 “–dport” 会是未知的参数 (arg) 呢？这是因为没有加上 <code>-p tcp</code> 或 <code>-p udp</code> 的缘故。这一点很重要。</p>
<p>除了端口之外，TCP 数据包还有特殊的标志。最常见的就是主动连接的 SYN 标志了。在 iptables 里面还支持 “–syn” 的处理方式，我们以下面的例子来说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将来自任何地方来源 port 1:1023 的主动连接到本机端的 1:1023 连接丢弃</span></span><br><span class="line">iptables -A INPUT -i eth0 -p tcp --sport 1:1023 \</span><br><span class="line">&gt; --dport 1:1023 --syn -j DROP</span><br></pre></td></tr></table></figure>
<p>一般来说，Client 端启用的 port 都大于 1024，而 Server 端启用的端口都小于 1023。所以我们可以丢弃来自远程的小于 1023 的端口数据的主动连接，但不适用于 FTP 的主动连接中。</p>
<h2 id="iptables-外挂模块：mac-与-state"><a href="#iptables-外挂模块：mac-与-state" class="headerlink" title="iptables 外挂模块：mac 与 state"></a>iptables 外挂模块：mac 与 state</h2><p>在 kernel 2.2 以前使用 <code>ipchains</code> 管理防火墙时，通常会让系统管理员相当头痛。因为 <code>ipchains</code> 没有所谓的数据包状态模块，因此我们必须要针对数据包的进、出方向进行控制。例如，如果想要连接到远程主机的 port 22 时，必须要针对两条规则来设置：</p>
<ul>
<li>本机端的 1024:65535 到远程的 port 22 必须要放行 (OUTPUT 链)。</li>
<li>远程主机 port 22 到本机的 1024:65535 必须放行 (INPUT 链)。</li>
</ul>
<p>这会很麻烦。因为要连接到 10 部主机的 port 22 时，假设 OUTPUT 为默认开启 (ACCEPT)， 那么久需要填写 10 行规则，让那 10 台远程主机的 port 22 可以连接到本地端主机上。如果开启全部的 port 22，则又担心某些恶意主机会主动以 port 22 连接到本地主机。同理，如果要让本地端主机可以连到外部的 port 80 (WWW 服务)，那就更不得了。<strong>因为网络连接是双向的</strong>，一个很重要的概念！</p>
<p>iptables 可以帮我们免除这个困扰。它可以通过一个状态模块来分析<strong>这个想要进入的数据包是否为刚刚发出去的响应，</strong>如果是刚刚发出去的响应，那么就可以予以接受放行。这样就不用考虑远程主机是否连接进来的问题了。那如何实现呢？看看下面的语法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT [-m state] [--state 状态]</span><br><span class="line">选项与参数：</span><br><span class="line">-m  <span class="comment"># 一些 iptables 的外挂模块，主要常见的有：</span></span><br><span class="line">     state  <span class="comment"># 状态模块</span></span><br><span class="line">     mac    <span class="comment"># 网络卡硬件地址 (hardware address)</span></span><br><span class="line">--state  <span class="comment"># 一些封包的状态，主要有：</span></span><br><span class="line">     INVALID     <span class="comment"># 无效的数据包，例如数据破损的数据包状态</span></span><br><span class="line">     ESTABLISHED <span class="comment"># 已经连接成功的连接状态</span></span><br><span class="line">     NEW         <span class="comment"># 想要新建立连接的数据包状态</span></span><br><span class="line">     RELATED     <span class="comment"># 这个最常用！表示这个数据包是与主机发送出去的数据包有关</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只要已建立连接或与已发出请求相关数据包就予以通过，不合法的数据报包就丢弃</span></span><br><span class="line">iptables -A INPUT -m state \</span><br><span class="line">&gt; --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A INPUT -m state --state INVALID -j DROP</span><br></pre></td></tr></table></figure>
<p>这样，iptables 就会主动分析出该数据包是否为响应状态，若是的话，就直接予以接受。这样不需要针对响应的数据包来撰写个别的防火墙规则了。下面我们继续谈一下 iptables 的另一个外挂， 那就是针对网卡来进行放行与防御：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 针对局域网络内的 aa:bb:cc:dd:ee:ff 主机开放其连接</span></span><br><span class="line">iptables -A INPUT -m mac --mac-source aa:bb:cc:dd:ee:ff \</span><br><span class="line">&gt; -j ACCEPT</span><br><span class="line">选项与参数：</span><br><span class="line">--mac-source  <span class="comment"># 就是来源主机的 MAC</span></span><br></pre></td></tr></table></figure>
<p>如果局域网当中有某些网络高手，老是可以通过修改 IP 去尝试通过路由器往外跑，那这时该怎么办？ 难道将整个局域网拒绝？并不需要的，可以通过之前谈到的 ARP 相关概念，去捕捉到那台主机的 MAC，然后通过以上这个机制，将该主机整个 DROP 掉即可。不管他改了什么 IP，除非他知道你是用网卡的 MAC 来管理，否则他是出不去的。</p>
<p>其实 MAC 也是可以伪装的，可以通过某些软件来修改网卡的 MAC。不过，这里我们是假设 MAC 是无法修改的情况来说明的。此外，MAC 是不能跨路由的，因此上述的案例中才特别说明是在局域网内，而不是指 Internet 外部的来源。</p>
<h2 id="ICMP-数据包规则的比对：针对是否响应-ping-来设计"><a href="#ICMP-数据包规则的比对：针对是否响应-ping-来设计" class="headerlink" title="ICMP 数据包规则的比对：针对是否响应 ping 来设计"></a>ICMP 数据包规则的比对：针对是否响应 ping 来设计</h2><p>在 ICMP 协议当中我们知道 ICMP 的类型很多，而且很多 ICMP 数据包的类型都是用来进行网络检测的。所以最好不要将所有的 ICMP 数据包都丢弃。如果主机不是作为路由器时，通常我们会把 ICMP type 8 (echo request) 拿掉，这样远程主机就不知道我们是否存在，也不会接受 ping 的响应。ICMP 数据包格式的处理是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT [-p icmp] [--icmp-type 类型] -j ACCEPT</span><br><span class="line">选项与参数：</span><br><span class="line">--icmp-type  <span class="comment"># 后面必须要接 ICMP 的数据包类型，也可以使用代号，</span></span><br><span class="line">              例如 8  代表 <span class="built_in">echo</span> request 的意思</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让 0,3,4,11,12,14,16,18 的 ICMP type 可以进入本机</span></span><br><span class="line">vim somefile</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">icmp_type=<span class="string">"0 3 4 11 12 14 16 18"</span></span><br><span class="line"><span class="keyword">for</span> typeicmp <span class="keyword">in</span> <span class="variable">$icmp_type</span>; <span class="keyword">do</span></span><br><span class="line">   iptables -A INPUT -i eth0 -p icmp --icmp-type <span class="variable">$typeicmp</span> -j ACCEPT</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">sh somefile</span><br></pre></td></tr></table></figure>
<p>这样就能够开放部分的 ICMP 数据包格式进入本机进行网络检测的工作了。不过，如果主机是作为局域网的路由器，那么建议 ICMP 数据包还是要全部放行才好，因为客户端检测网络时，常常会使用 ping 来测试到路由器的线路是否畅通。所以不要将路由器的 ICMP 关掉，会导致相关应用异常。</p>
<h2 id="简单的客户端防火墙设计与防火墙规则存储"><a href="#简单的客户端防火墙设计与防火墙规则存储" class="headerlink" title="简单的客户端防火墙设计与防火墙规则存储"></a>简单的客户端防火墙设计与防火墙规则存储</h2><p>经过上述的本机 iptables 语法分析后，接下来我们来想想，如果将 Linux 主机作为客户端且不提供网络服务时，应该如何设计防火墙呢？其实，只要分析一下 CentOS 默认的防火墙规则就会知道，理论上，应该要有的规则如下：</p>
<ol>
<li>规则归零：清除所有已经存在的规则 (iptables -F 等)</li>
<li>默认策略：除了将 INPUT 这个自定义链设为 DROP 外，其他默认为 ACCEPT。</li>
<li>信任本机：由于 lo 对本机来说是相当重要的，因此 lo 必须设置为信任设备。</li>
<li>回应数据包：让本机通过主动向外发出请求而响应的数据包可以进入本机 (ESTABLISHED、RELATED)</li>
<li>信任用户：这是非必要的，可在想要让本地网络的来源使用主机资源时设置。</li>
</ol>
<p>这就是最简单的防火墙，通过第 2 步骤可以阻挡所有远程的来源数据包，而通过第 4 步骤可以允许远程主机响应数据包进入主机，再让本机的 lo 这个内部循环设备放行，这样，一台 Client 专用的防火墙规则就配置好了。具体设置时，可以在某个 script 上面这样做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim firewall.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin; <span class="built_in">export</span> PATH</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 清除规则</span></span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 设置策略</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3~5. 制订各项规则</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="comment"># iptables -A INPUT -i eth0 -s 192.168.1.0/24 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 写入防火墙规则配置文件</span></span><br><span class="line">/etc/init.d/iptables save</span><br><span class="line"></span><br><span class="line">sh firewall.sh</span><br><span class="line">iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]</span><br></pre></td></tr></table></figure>
<p>其实防火墙也是一个服务，并可以通过 <code>chkconfig --list iptables</code> 或 <code>systemctl -l status iptables</code> 去查看。因此，若要让这次修改的各种设置在下次开机时还保存，那就需要对 <code>/etc/init.d/iptables save</code> 这个指令加参数。 因此，现在将存储的操作写入 firewall.sh 脚本中，比较单纯些。通过以上设置，现在，Linux 主机已经有相当的保护了，只是如果想要作为服务器，或者是作为路由器，那就需要自行加上某些自定义的规则。</p>
<p><strong>Tips:</strong> 其实，如果你对 Linux 够熟悉的话，直接去修改 <code>/etc/sysconfig/iptables</code> 然后重启 iptables 这个服务，那防火墙规则就会在开机后持续存在了。</p>
<h2 id="IPv4-的核心管理功能：-proc-sys-net-ipv4"><a href="#IPv4-的核心管理功能：-proc-sys-net-ipv4" class="headerlink" title="IPv4 的核心管理功能：/proc/sys/net/ipv4/"></a>IPv4 的核心管理功能：/proc/sys/net/ipv4/</h2><p>除了 iptables 这个防火墙软件之外，Linux kernel 2.6 还提供了很多内核默认的攻击阻挡机制。由于是内核的网络功能，所以相关的设置数据都是放置在 <code>/proc/sys/net/ipv4/</code> 这个目录当中。 至于该目录下各个文件的详细资料，可以参考内核的说明文件（你得要先安装 kernel-doc 软件）：</p>
<ul>
<li>/usr/share/doc/kernel-doc-2.6.32/Documentation/networking/ip-sysctl.txt<br>鸟哥的网站上也放了一份备份：</li>
<li>http:/linux.vbird.org/linux_server/0250simple_firewall/ip-sysctl.txt<br>有兴趣的话应该要自行去查看。我们下面来介绍几个简单的文件。</li>
</ul>
<p><strong>1. /proc/sys/net/ipv4/tcp_syncookies</strong><br>我们在前面谈到所谓的阻断式服务 (DoS) 攻击法当中的一种方式，就是利用 TCP 数据包的 SYN 三次握手原理实现的，这种方式称为 SYN Flooding。那如何预防这种方式的攻击呢？我们可以启用内核的 SYN Cookie 模块。这个 SYN Cookie 模块可以在系统用来启动随机连接的端口 (1024:65535) 即将用完时自动启动。</p>
<p><strong>当启动 SYN Cookie 时，主机在发送 SYN/ACK 确认数据包前，会要求 Client 端在短时间内回复一个序号，这个序号包含许多原 SYN 数据包内的信息，包括 IP、port 等。若 Client 端可以回复正确的序号，那么主机就确定该数据包为可信的，因此会发送 SYN/ACK 数据包，否则就不理会此数据包。</strong></p>
<p>通过这一机制可以大大降低无效的 SYN 等待端口，避免 SYN Flooding 的 DoS 攻击。那么如何启动这个模块呢？很简单，这样做即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/tcp_syncookies</span><br></pre></td></tr></table></figure>
<p>但是这个设置值由于违反 TCP 的三次握手（因为主机在发送 SYN/ACK 之前需要先等待 Client 的序号响应），所以可能会造成某些服务的延迟现象，例如 SMTP (Mail Server)。不过总的来说，这个设置值还是不错，<strong>只是不适合用在负载已经很高的服务器内。</strong>因为负载太高的主机有时会让内核误判遭受 SYN Flooding 的攻击。</p>
<p>如果是为了系统的 TCP 数据包连接优化，则可以参考 tcp_max_syn_backlog、tcp_synack_retries、tcp_abort_on_overflow 这几个设置值的意义。</p>
<p><strong>2. /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</strong></p>
<p>阻断式服务常见的是 SYN Flooding，不过，我们知道系统其实可以接受使用 ping 的响应，而 <a href="http://cn.linux.vbird.org/linux_server/0140networkcommand.php#ping" target="_blank" rel="noopener">ping</a> 的数据包数据量可以很大。想象一个状况，如果有个搞破坏的人使用 1000 台主机传送 ping 给你的主机，而且每个 ping 都高达数百 Kbytes 时，你的网络带宽会怎样？要么就是带宽被吃光，要么系统可能会宕机。这种方式分别被称为 ping flooding（不断发 ping）及 ping of death（发送大的 ping 数据包）。</p>
<p>那如何避免呢？取消 ICMP 类型 8 的 ICMP 数据包回应就是了。我们可以通过防火墙来阻挡，这也是建议的方式。当然也可以让内核自动取消 ping 的响应。不过，<strong>某些局域网络内常见的服务（例如动态 IP 分配 DHCP 协议）会使用 ping 的方式来侦测是否有重复的 IP，所以最好不要取消所有的 ping 响应比较好。</strong></p>
<p>内核取消 ping 回应的设置值有两个，分别是 <code>/proc/sys/net/ipv4</code> 内的 icmp_echo_ignore_broadcasts（仅有 ping broadcast 地址时才取消 ping 的回应）及 icmp_echo_ignore_all（全部的 ping 都不回应）。建议设置  icmp_echo_ignore_broadcasts。可以这么做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; \</span><br><span class="line">&gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</span><br></pre></td></tr></table></figure>
<p><strong>3. /proc/sys/net/ipv4/conf/网络接口/*</strong></p>
<p>Linux 的内核还可以针对不同的网络接口进行不一样的参数设置。网络接口的相关设置放置在 <code>/proc/sys/net/ipv4/conf/</code> 中，每个接口都以接口代号做为其代表，例如 eth0 接口的相关设置数据在 <code>/proc/sys/net/ipv4/conf/eth0/</code> 内。那么网络接口的设置数据有哪些需要注意的呢？ 大概有下面这几个：</p>
<ul>
<li><p><strong>rp_filter</strong>：称为逆向路径过滤 (Reverse Path Filtering)，可以通过分析网络接口的路由信息，配合数据包的来源地址，来分析该数据包是否为合理。举例来说，你有两张网卡，eth0 为 192.168.1.10/24，eth1 为 public IP。那么当有一个数据包自称来自 eth1，但是其 IP 来源为 192.168.1.200，那这个数据包就不合理，应予以丢弃。这个设置值建议启动。</p>
</li>
<li><p><strong>log_martians</strong>：这个设置数据可以用来启动记录不合法的 IP 来源的功能，举例来说，包括来源为 0.0.0.0、127.x.x.x、及 Class E 的 IP 都是不合法的，因为这些来源的 IP 不应该应用于 Internet。记录的数据默认放置到内核放置的日志文件 <code>/var/log/messages</code>。</p>
</li>
<li><p><strong>accept_source_route</strong>：或许某些路由器会启动这个设置值，不过目前的设备很少使用到这种来源路由，可以取消这个设置值。</p>
</li>
<li><p><strong>accept_redirects</strong>：当你在同一个实体网络内架设一台路由器，但这个实体网络有两个 IP 网络，例如 192.168.0.0/24、 192.168.1.0/24。此时 192.168.0.100 想要向 192.168.1.100 传送信息时，路由器可能会传送一个 ICMP redirect 数据包告知 192.168.0.100 直接传送数据给 192.168.1.100 即可，而不需通过路由器。因为 192.168.0.100 与 192.168.1.100 确实是在同一个实体线路上（两者可以直接互通），所以路由器会告知来源 IP 使用最短路径去传递数据。但由于那两台主机在不同的 IP 网段，所以还是无法实际传递信息。这个设置也可能会产生一些轻微的安全风险，所以建议关闭。</p>
</li>
<li><p><strong>send_redirects</strong>：与上一个类似，只是此值为发送一个 ICMP redirect 数据包。同样建议关闭。</p>
</li>
</ul>
<p>虽然可以使用 <code>echo &quot;1&quot; &gt; /proc/sys/net/ipv4/conf/???/rp_filter</code> 来启动这个项目，不过，比较建议修改系统设置值，即 <code>/etc/sysctl.conf</code> 这个文件。假设我们仅有 eth0 这个以太接口，而且上述的功能要全部启动，那可以这样做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment"># Adding by VBird 2011/01/28</span></span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts = 1</span><br><span class="line">net.ipv4.conf.all.rp_filter = 1</span><br><span class="line">net.ipv4.conf.default.rp_filter = 1</span><br><span class="line">net.ipv4.conf.eth0.rp_filter = 1</span><br><span class="line">net.ipv4.conf.lo.rp_filter = 1</span><br><span class="line">....(以下省略)....</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://cn.linux.vbird.org/linux_server/0250simple_firewall_3.php" target="_blank" rel="noopener">http://cn.linux.vbird.org/linux_server/0250simple_firewall_3.php</a></p>

      
    </div>
    
    
    

    <div style="text-align:center;color: #ccc;font-size:14px;">---------------- The End ----------------</div>
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iptables防火墙数据包过滤软件/" rel="tag"># iptables防火墙数据包过滤软件</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/11/Django-2.x后生成数据库表时的报错/" rel="next" title="Django 2.x 后生成数据库表时的报错">
                <i class="fa fa-chevron-left"></i> Django 2.x 后生成数据库表时的报错
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/19/iptables防火墙实例/" rel="prev" title="iptables防火墙实例">
                iptables防火墙实例 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/20180226143321.jpg"
                alt="G加菲" />
            
              <p class="site-author-name" itemprop="name">G加菲</p>
              <p class="site-description motion-element" itemprop="description">很喜欢吃~吃完就睡~所以长得很胖</p>
          </div>

          <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 
          src="//music.163.com/outchain/player?type=0&id=2188265841&auto=1&height=90"></iframe>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">137</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">137</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/" target="_blank" title="weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>weibo</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/jy00278439" target="_blank" title="zhihu">
                      
                        <i class="fa fa-fw fa-zhihu"></i>zhihu</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.gmlyo.com/" title="G加菲" target="_blank">G加菲</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables防火墙数据包过滤软件"><span class="nav-number">1.</span> <span class="nav-text">iptables防火墙数据包过滤软件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables-的表-table-与链-chain"><span class="nav-number">1.1.</span> <span class="nav-text">iptables 的表 (table) 与链 (chain)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Filter（过滤器）"><span class="nav-number">1.1.1.</span> <span class="nav-text">Filter（过滤器）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NAT（地址转换）"><span class="nav-number">1.1.2.</span> <span class="nav-text">NAT（地址转换）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mangle（破坏者）"><span class="nav-number">1.1.3.</span> <span class="nav-text">Mangle（破坏者）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#列出-filter-table-三条链的规则"><span class="nav-number">1.2.</span> <span class="nav-text">列出 filter table 三条链的规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#列出-nat-table-三条链的规则"><span class="nav-number">1.3.</span> <span class="nav-text">列出 nat table 三条链的规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义默认策略-policy"><span class="nav-number">1.4.</span> <span class="nav-text">定义默认策略 (policy)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据包的基础比对：IP，网络及接口设备"><span class="nav-number">1.5.</span> <span class="nav-text">数据包的基础比对：IP，网络及接口设备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP、UDP-的规则比对：针对端口设置"><span class="nav-number">1.6.</span> <span class="nav-text">TCP、UDP 的规则比对：针对端口设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables-外挂模块：mac-与-state"><span class="nav-number">1.7.</span> <span class="nav-text">iptables 外挂模块：mac 与 state</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ICMP-数据包规则的比对：针对是否响应-ping-来设计"><span class="nav-number">1.8.</span> <span class="nav-text">ICMP 数据包规则的比对：针对是否响应 ping 来设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#简单的客户端防火墙设计与防火墙规则存储"><span class="nav-number">1.9.</span> <span class="nav-text">简单的客户端防火墙设计与防火墙规则存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv4-的核心管理功能：-proc-sys-net-ipv4"><span class="nav-number">1.10.</span> <span class="nav-text">IPv4 的核心管理功能：/proc/sys/net/ipv4/</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">1.11.</span> <span class="nav-text">参考文档</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">G加菲</span>

  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>

-->



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数(UV)
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量(PV)
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  


<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":100,"height":200},"mobile":{"show":false}});</script></body>
</html>
